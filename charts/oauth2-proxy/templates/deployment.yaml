{{- range .Values.oauth2proxyInstances }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .name }}-oauth2-proxy
  namespace: {{ .namespace }}
  labels:
    app.kubernetes.io/name: oauth2-proxy
    app.kubernetes.io/instance: {{ .name }}
    app.kubernetes.io/managed-by: {{ $.Release.Service }}
spec:
  replicas: {{ .replicaCount | default $.Values.replicaCount }}
  selector:
    matchLabels:
      app.kubernetes.io/name: oauth2-proxy
      app.kubernetes.io/instance: {{ .name }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: oauth2-proxy
        app.kubernetes.io/instance: {{ .name }}
    spec:
      {{- with .nodeSelector | default $.Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .serviceAccount | default $.Values.serviceAccount }}
      serviceAccountName: {{ .name | default (printf "%s-oauth2-proxy" (include "oauth2-proxy.fullname" $)) }}
      {{- end }}
      containers:
        - name: oauth2-proxy
          image: "{{ $.Values.image.repository }}:{{ $.Values.image.tag }}"
          imagePullPolicy: {{ $.Values.image.pullPolicy }}
          args:
            - --http-address=0.0.0.0:4180
            - --upstream={{ .upstream }}
            - --redirect-url={{ .redirectURL }}
            # Default args from global, can be overridden by instance specific args
            - --provider={{ .args.provider | default $.Values.defaultArgs.provider }}
            {{- range .args.emailDomains | default $.Values.defaultArgs.emailDomains }}
            - --email-domain={{ . }}
            {{- end }}
            - --cookie-secure={{ .args.cookieSecure | default $.Values.defaultArgs.cookieSecure | quote }}
            - --cookie-http-only={{ .args.cookieHttpOnly | default $.Values.defaultArgs.cookieHttpOnly | quote }}
            - --cookie-expire={{ .args.cookieExpire | default $.Values.defaultArgs.cookieExpire | quote }}
            - --cookie-refresh={{ .args.cookieRefresh | default $.Values.defaultArgs.cookieRefresh | quote }}
            {{- if .args.cookieDomain | default $.Values.defaultArgs.cookieDomain }}
            - --cookie-domain={{ .args.cookieDomain | default $.Values.defaultArgs.cookieDomain }}
            {{- end }}
            - --set-xauthrequest={{ .args.setXAuthRequest | default $.Values.defaultArgs.setXAuthRequest | quote }}
            - --pass-access-token={{ .args.passAccessToken | default $.Values.defaultArgs.passAccessToken | quote }}
            - --pass-authorization-header={{ .args.passAuthorizationHeader | default $.Values.defaultArgs.passAuthorizationHeader | quote }}
            {{- if .args.sslInsecureSkipVerify | default $.Values.defaultArgs.sslInsecureSkipVerify }}
            - --ssl-insecure-skip-verify={{ .args.sslInsecureSkipVerify | default $.Values.defaultArgs.sslInsecureSkipVerify | quote }}
            {{- end }}
            {{- range .args.whitelistDomains | default $.Values.defaultArgs.whitelistDomains }}
            - --whitelist-domain={{ . }}
            {{- end }}
            # Instance specific extra args
            {{- range .extraArgs }}
            - {{ . }}
            {{- end }}
          env:
            - name: OAUTH2_PROXY_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: {{ .credentials.existingSecretName | default (printf "%s-oauth2-credentials" .name) }}
                  key: clientID
            - name: OAUTH2_PROXY_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ .credentials.existingSecretName | default (printf "%s-oauth2-credentials" .name) }}
                  key: clientSecret
            - name: OAUTH2_PROXY_COOKIE_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ .credentials.existingSecretName | default (printf "%s-oauth2-credentials" .name) }}
                  key: cookieSecret
          ports:
            - containerPort: 4180
              name: http
          {{- with .resources | default $.Values.resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}
---
{{- end }}