#!/bin/bash
set -e
# Script de arranque para nodos worker de k3s en ASG

MASTER_IP="${master_private_ip}"

# Escribir la clave privada en el worker
cat <<'EOF' > /home/ubuntu/.ssh/k3s-key.pem
${k3s_private_key_pem}
EOF
chmod 400 /home/ubuntu/.ssh/k3s-key.pem
chown ubuntu:ubuntu /home/ubuntu/.ssh/k3s-key.pem

TOKEN="$(ssh -o StrictHostKeyChecking=no -i /home/ubuntu/.ssh/k3s-key.pem ubuntu@${master_private_ip} sudo cat /var/lib/rancher/k3s/server/node-token)"

sudo apt-get update -y
# Obtener providerID AWS
INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
AVAIL_ZONE=$(curl -s http://169.254.169.254/latest/meta-data/placement/availability-zone)
PROVIDER_ID="aws:///$AVAIL_ZONE/$INSTANCE_ID"

# Eliminar cualquier instalaci贸n previa de k3s para asegurar la versi贸n correcta
yes | /usr/local/bin/k3s-uninstall.sh 2>/dev/null || true

# Instalar k3s agent con versi贸n fija (sin providerID)
K3S_VERSION="v1.32.5+k3s1"
curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION=$K3S_VERSION K3S_URL=https://$MASTER_IP:6443 K3S_TOKEN=$TOKEN sh -s - agent

# Verificar versi贸n instalada
k3s --version

# Etiquetar el nodo como worker
LOCAL_HOSTNAME=$(hostname)
ssh -o StrictHostKeyChecking=no -i /home/ubuntu/.ssh/k3s-key.pem ubuntu@$MASTER_IP "kubectl label node $LOCAL_HOSTNAME ${worker_label} --overwrite"
